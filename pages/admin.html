<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getnaro Admin Pro</title>
    <link rel="stylesheet" href="/stylesheets/header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* BASE STYLES */
        body { background-color: #050505; color: #e0e0e0;}
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #9F00FF; border-radius: 4px; }

        .gn-border { border-color: #9F00FF; }
        .gn-text { color: #9F00FF; }
        .gn-bg { background-color: #9F00FF; }
        .gn-bg:hover { background-color: #7a00c4; }
        
        .loader { border: 3px solid #333; border-top: 3px solid #9F00FF; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #admin-toast {
            visibility: hidden; min-width: 250px; background-color: #1a1a1a; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 5000; left: 50%; bottom: 30px;
            transform: translateX(-50%); border: 1px solid #9F00FF; box-shadow: 0 4px 15px rgba(159, 0, 255, 0.3);
            opacity: 0; transition: opacity 0.3s, bottom 0.3s ;
        }
        #admin-toast.show { visibility: visible; opacity: 1; bottom: 50px;  }
        .container{
            position: relative;
            left: 0;
            top: 100px;
            right: 0;
            margin: auto;
            padding-bottom: 100px;
        }
        /* FIX: Ensure modal is centered and covers screen */
        #custom-modal, #user-detail-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
            z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #111; border: 1px solid #333; border-left: 4px solid #9F00FF; 
            padding: 25px; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            transform: scale(0.9); animation: popIn 0.2s forwards;
            max-height: 90vh; overflow-y: auto;
        }
        @keyframes popIn { to { transform: scale(1); } }
        
        /* Dashboard Layout */
        .tab-button.active {
            background-color: #9F00FF !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(159, 0, 255, 0.3);
        }
        .data-card {
            background: #111;
            padding: 16px;
            border-radius: 10px;
            border-left: 3px solid #9F00FF;
            margin-bottom: 12px;
        }
        .user-detail-line {
             display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #222;
        }
        .user-detail-line span:last-child { color: #9F00FF; font-weight: bold; }
        
        /* FIX: User Database search icon positioning */
        #tab-users .search-wrapper {
             position: relative;
             display: flex;
             align-items: center;
             width: 100%;
        }
        #tab-users .search-wrapper i.fa-search {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .lg\:col-span-2 .flex {
            align-items: center;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-black">

    <canvas id="gn-particles"></canvas>
    
    <!-- HEADER -->
    <div class="heading">
        <a href="/index.html"><img src="/assests/logo-getnaro-nobg.png" class="logo"></a>
        <h4>Getnaro</h4>
        <ul>
            <li><a href="/index.html">HOME</a></li>
            <li><a href="/pages/community.html">COMMUNITY</a></li>
            <li><a href="/pages/login.html">ACCOUNT</a></li>
            <li><a href="/pages/about.html">ABOUT US</a></li>
            <li><a href="/pages/faq.html">FAQ</a></li>
        </ul>
        <button id="theme-toggle" class="theme-toggle"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
        <div id="gn-search-btn" class="gn-search-btn"><i class="fa-solid fa-magnifying-glass"></i></div>
        <a class="dl" href="/pages/getnaro-app.html"><i class="fa-solid fa-download"></i> DOWNLOAD APP</a>
    </div>

    <!-- HAMBURGER (omitted for brevity) -->
    
    <!-- SEARCH (omitted for brevity) -->

<div class="container">
    
    <!-- CUSTOM TOAST -->
    <div id="admin-toast"><i class="fa-solid fa-info-circle"></i> <span id="toast-msg">Notification</span></div>

    <!-- CUSTOM MODAL: Used for Delete Confirmations, etc. -->
    <div id="custom-modal">
        <div class="modal-box">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-2">Confirm</h3>
            <p id="modal-msg" class="text-gray-400 mb-6">Are you sure?</p>
            <div id="modal-input-container" class="hidden mb-4">
                <input type="text" id="modal-input" class="w-full bg-black border border-gray-700 p-2 text-white rounded focus:border-purple-500 outline-none">
            </div>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button id="modal-confirm" class="px-6 py-2 gn-bg text-white rounded font-bold shadow-lg">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- USER DETAIL MODAL: NEW -->
    <div id="user-detail-modal" class="modal-overlay">
        <div class="modal-box max-w-xl">
             <div class="flex justify-between items-center pb-3 border-b border-gray-700 mb-4">
                 <h3 class="text-2xl font-bold text-white"><i class="fa-solid fa-user-shield gn-text mr-2"></i> User Profile</h3>
                 <!-- FIX: Clear close button toggle -->
                 <button onclick="document.getElementById('user-detail-modal').style.display='none'" class="text-gray-500 hover:text-white text-3xl leading-none">&times;</button>
             </div>
             
             <h4 class="text-lg font-bold gn-text mb-3">User Details (Auth & Profile)</h4>
             <div class="text-sm space-y-1 mb-6">
                 <div class="user-detail-line"><span>Auth UID:</span> <span id="modal-user-uid" class="text-xs font-mono"></span></div>
                 <div class="user-detail-line"><span>Display Name:</span> <span id="modal-user-name"></span></div>
                 <div class="user-detail-line"><span>Email:</span> <span id="modal-user-email"></span></div>
                 <div class="user-detail-line"><span>Join Date:</span> <span id="modal-user-join-date"></span></div>
                 <div class="user-detail-line"><span>Status:</span> <span id="modal-user-status" class="text-red-500"></span></div>
             </div>

             <div class="flex justify-end gap-3 pt-3 border-t border-gray-800">
                 <button id="modal-revoke-btn" class="bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg text-sm font-bold transition"><i class="fa-solid fa-user-slash"></i> Revoke Session</button>
                 <button id="modal-view-rtdb-btn" class="bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white px-4 py-2 rounded-lg text-sm font-bold transition"><i class="fa-solid fa-database"></i> View RTDB Data</button>
             </div>
        </div>
    </div>

    <!-- LOGIN SECTION -->
    <div id="login-section" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-gray-900 p-8 rounded-2xl border border-gray-800 shadow-2xl w-full max-w-md text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 gn-bg"></div>
            <i class="fa-solid fa-user-secret text-6xl gn-text mb-6"></i>
            <h2 class="text-3xl font-bold mb-8 text-white tracking-wider">ADMIN ACCESS</h2>
            <input type="email" id="admin-email" class="w-full bg-black border border-gray-700 rounded-lg p-4 mb-4 text-white focus:outline-none focus:border-purple-500 transition" placeholder="Command Email">
            <input type="password" id="admin-pass" class="w-full bg-black border border-gray-700 rounded-lg p-4 mb-8 text-white focus:outline-none focus:border-purple-500 transition" placeholder="Passkey">
            <button id="admin-login-btn" class="w-full gn-bg text-white font-bold py-4 rounded-lg hover:shadow-[0_0_20px_rgba(159,0,255,0.5)] transition duration-300 uppercase tracking-widest">
                Authenticate
            </button>
            <p id="login-msg" class="mt-6 text-red-500 text-sm font-mono"></p>
        </div>
    </div>

    <!-- DASHBOARD CONTENT -->
    <div id="dashboard-content" class="hidden w-full max-w-[1400px] mx-auto p-6 mt-8">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 bg-gray-900 p-6 rounded-2xl border-l-4 gn-border shadow-lg gap-4">
            <div>
                <h1 class="text-4xl font-bold text-white">Getnaro <span class="gn-text">Dashboard</span></h1>
                <p class="text-gray-500 mt-1">Database Management System</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="import-toggle-btn" class="bg-gray-800 border border-gray-600 hover:border-purple-500 text-white px-5 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-import text-green-400"></i> Import JSON
                </button>
                <button id="delete-all-btn" class="bg-gray-800 border border-gray-600 hover:border-red-500 text-white px-5 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-radiation text-red-500"></i> Wipe Apps
                </button>
                <a href="/index.html" target="_blank" class="bg-gray-800 border border-gray-600 hover:text-white hover:border-purple-500 text-gray-400 px-4 py-3 rounded-lg transition flex items-center justify-center" title="View Site">
                    <i class="fa-solid fa-external-link-alt"></i>
                </a>
                <button id="logout-btn" class="bg-red-900/20 border border-red-900/50 text-red-500 hover:bg-red-600 hover:text-white px-6 py-3 rounded-lg transition font-bold">
                    Logout
                </button>
            </div>
        </div>

        <!-- DASHBOARD TABS -->
        <div class="mb-8">
            <div class="flex flex-wrap gap-2 border-b border-gray-700 pb-2">
                <button data-tab="stats" class="tab-button bg-gray-800 hover:gn-bg text-gray-300 px-4 py-2 rounded-lg font-bold transition active"><i class="fa-solid fa-chart-line"></i> Global Stats</button>
                <button data-tab="apps" class="tab-button bg-gray-800 hover:gn-bg text-gray-300 px-4 py-2 rounded-lg font-bold transition"><i class="fa-solid fa-list-check"></i> App Library</button>
                <button data-tab="users" class="tab-button bg-gray-800 hover:gn-bg text-gray-300 px-4 py-2 rounded-lg font-bold transition"><i class="fa-solid fa-users"></i> User Database</button>
                <button data-tab="config" class="tab-button bg-gray-800 hover:gn-bg text-gray-300 px-4 py-2 rounded-lg font-bold transition"><i class="fa-solid fa-cog"></i> Site Config</button>
            </div>
        </div>

        <!-- TAB CONTENT CONTAINER -->
        <div id="tab-content-container">

            <!-- 1. GLOBAL STATS TAB -->
            <div id="tab-stats" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                    <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 hover:border-purple-500/50 transition group">
                        <h3 class="text-gray-500 text-xs uppercase font-bold tracking-widest">Total Apps</h3>
                        <p id="total-apps-count" class="text-3xl font-bold text-white mt-2 group-hover:gn-text transition">0</p>
                    </div>
                    <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 hover:border-green-500/50 transition group">
                        <h3 class="text-gray-500 text-xs uppercase font-bold tracking-widest">Global Downloads</h3>
                        <p id="global-downloads-count" class="text-3xl font-bold text-white mt-2 group-hover:text-green-400 transition">0</p>
                    </div>
                    <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 hover:border-blue-500/50 transition group">
                        <h3 class="text-gray-500 text-xs uppercase font-bold tracking-widest">Live Visitors (RTDB)</h3>
                        <p id="live-visitors-count" class="text-3xl font-bold text-white mt-2 group-hover:text-blue-400 transition">0</p>
                    </div>
                    <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 hover:border-red-500/50 transition group">
                        <h3 class="text-gray-500 text-xs uppercase font-bold tracking-widest">Peak Visitors (RTDB)</h3>
                        <p id="peak-visitors-count" class="text-3xl font-bold text-white mt-2 group-hover:text-red-400 transition">0</p>
                    </div>
                </div>
            </div>

            <!-- 2. APP LIBRARY TAB (Original Content) -->
            <div id="tab-apps" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- EDITOR FORM -->
                    <div class="lg:col-span-1 bg-gray-900 p-8 rounded-2xl border border-gray-800 h-fit sticky top-6 shadow-xl">
                        <!-- ... (Editor Form content remains the same) ... -->
                         <h3 class="text-xl font-bold mb-6 pb-4 border-b border-gray-800 flex items-center gap-3 text-white">
                            <i class="fa-solid fa-pen-to-square gn-text"></i> App Editor
                        </h3>
                        
                        <input type="hidden" id="app-doc-id">

                        <div class="space-y-5">
                            <div>
                                <label class="block text-xs text-gray-500 uppercase font-bold mb-2">App ID (URL Slug)</label>
                                <input type="text" id="app-id" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-white focus:border-purple-500 focus:outline-none transition" placeholder="e.g. cpu-z">
                            </div>
                            
                            <div>
                                <label class="block text-xs text-gray-500 uppercase font-bold mb-2">Display Name</label>
                                <input type="text" id="app-name" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-white focus:border-purple-500 focus:outline-none transition" placeholder="e.g. CPU-Z">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-500 uppercase font-bold mb-2">Category</label>
                                    <select id="app-category" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-white focus:border-purple-500 focus:outline-none appearance-none cursor-pointer">
                                        <option value="social">Social Media</option>
                                        <option value="tools">Tools / Utilities</option>
                                        <option value="opensource">Open Source</option>
                                        <option value="desi">Desi Apps</option>
                                        <option value="gaming">Gaming</option>
                                        <option value="office">Office / Productivity</option>
                                        <option value="drivers">Drivers / System</option>
                                        <option value="video">Video / Graphics</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 uppercase font-bold mb-2">Version</label>
                                    <input type="text" id="app-version" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-white focus:border-purple-500 focus:outline-none" placeholder="v1.0">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs text-gray-500 uppercase font-bold mb-2">Search Tags</label>
                                <input type="text" id="app-tags" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-white focus:border-purple-500 focus:outline-none" placeholder="comma, separated, tags">
                            </div>

                            <div>
                                <label class="block text-xs text-gray-500 uppercase font-bold mb-2">Description</label>
                                <textarea id="app-desc" rows="5" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-gray-300 focus:border-purple-500 focus:outline-none" placeholder="Full description here..."></textarea>
                            </div>

                            <div>
                                <label class="block text-xs text-gray-500 uppercase font-bold mb-2">Download Link</label>
                                <input type="text" id="app-download-link" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-blue-400 focus:border-purple-500 focus:outline-none" placeholder="https://...">
                            </div>
                            
                             <div>
                                <label class="block text-xs text-gray-500 uppercase font-bold mb-2">Icon URL</label>
                                <input type="text" id="app-image" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-white focus:border-purple-500 focus:outline-none" placeholder="/images/icon.png">
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button id="save-app-btn" class="flex-1 gn-bg hover:bg-purple-600 text-white py-3 rounded-lg font-bold transition shadow-lg">
                                    <i class="fa-solid fa-save"></i> Save App
                                </button>
                                <button id="clear-form-btn" class="px-6 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-lg font-bold transition">
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- LIST -->
                    <div class="lg:col-span-2 bg-gray-900 p-8 rounded-2xl border border-gray-800 shadow-xl">
                        <div class="flex justify-between items-center mb-8">
                            <h3 class="text-xl font-bold text-white flex items-center gap-3"><i class="fa-solid fa-list gn-text"></i> App Library</h3>
                            <div class="relative w-72">
                                <input type="text" id="search-apps" placeholder="Filter library..." class="bg-black border border-gray-700 rounded-full px-6 py-3 pl-12 text-sm text-white w-full focus:border-purple-500 focus:outline-none transition">
                                <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-500"></i>
                            </div>
                        </div>
                        
                        <div class="overflow-hidden rounded-xl border border-gray-800">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-black text-gray-300 uppercase font-bold tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4 border-b border-gray-800">Name / ID</th>
                                        <th class="px-6 py-4 border-b border-gray-800">Category</th>
                                        <th class="px-6 py-4 border-b border-gray-800 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="app-table-body" class="divide-y divide-gray-800 bg-gray-900/50">
                                    <tr><td colspan="3" class="px-6 py-12 text-center text-gray-500"><div class="loader"></div><br><span class="mt-2 inline-block text-xs">Syncing with Database...</span></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. USER DATABASE TAB -->
            <div id="tab-users" class="tab-content hidden">
                <div class="bg-gray-900 p-8 rounded-2xl border border-gray-800 shadow-xl">
                    <h3 class="text-xl font-bold mb-6 pb-4 border-b border-gray-800 flex items-center gap-3 text-white"><i class="fa-solid fa-database gn-text"></i> User Search & Management</h3>
                    
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <div class="search-wrapper flex-grow">
                            <input type="text" id="user-search-input" placeholder="Search by User ID or Email" class="bg-black border border-gray-700 rounded-full px-6 py-3 pl-12 text-sm text-white w-full focus:border-purple-500 focus:outline-none transition">
                            <!-- FIX: User search icon position -->
                            <i class="fa-solid fa-search text-gray-500"></i> 
                        </div>
                        <button id="search-user-btn" class="gn-bg text-white px-6 py-3 rounded-full font-bold transition flex items-center justify-center gap-2"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
                    </div>

                    <!-- USER RESULT AREA -->
                    <div id="user-result-card" class="mt-6 border border-gray-800 rounded-xl p-4 bg-gray-800/50 hidden">
                        <div class="flex items-center gap-4 border-b border-gray-700 pb-3 mb-3">
                            <i class="fa-solid fa-user text-3xl gn-text"></i>
                            <div>
                                <p id="user-display-name" class="text-lg font-bold text-white"></p>
                                <p id="user-email-id" class="text-xs text-gray-400"></p>
                            </div>
                            <button id="user-delete-btn" class="ml-auto bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white px-3 py-2 rounded-lg text-sm font-bold transition"><i class="fa-solid fa-user-slash"></i> Delete Account</button>
                            <button id="user-view-details-btn" class="bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white px-3 py-2 rounded-lg text-sm font-bold transition"><i class="fa-solid fa-info-circle"></i> Details</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <h4 class="text-sm font-bold gn-text mb-2 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> Download History</h4>
                                <div id="user-download-history" class="h-48 overflow-y-auto pr-2">
                                    <p class="text-gray-500 text-xs">Search a user to view history.</p>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold gn-text mb-2 flex items-center gap-2"><i class="fa-solid fa-heart"></i> Favourites</h4>
                                <div id="user-favourites" class="h-48 overflow-y-auto pr-2">
                                    <p class="text-gray-500 text-xs">Search a user to view favorites.</p>
                                </div>
                            </div>
                        </div>
                        <p id="user-data-warning" class="text-xs text-red-400 mt-4 hidden">Warning: Download history is sourced from Realtime Database (RTDB).</p>
                    </div>

                    <p id="user-search-msg" class="mt-4 text-gray-500 text-sm">Use the search bar above to manage user history and data. Only RTDB records (history/favorites) can be managed via the Admin Panel.</p>
                </div>
            </div>

            <!-- 4. SITE CONFIG TAB -->
            <div id="tab-config" class="tab-content hidden">
                <div class="bg-gray-900 p-8 rounded-2xl border border-gray-800 shadow-xl">
                    <h3 class="text-xl font-bold mb-6 pb-4 border-b border-gray-800 flex items-center gap-3 text-white"><i class="fa-solid fa-cogs gn-text"></i> Global Configuration & System Health</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Site Settings -->
                        <div class="p-4 border border-gray-700 rounded-lg">
                             <h4 class="text-lg font-bold text-white mb-3">Site Behavior Toggles</h4>
                             <label class="flex items-center justify-between py-2 border-b border-gray-800 last:border-b-0">
                                 <span class="text-sm text-gray-300">Disable User Signups</span>
                                 <input type="checkbox" id="toggle-signups" class="h-5 w-5 gn-bg border-gray-700 rounded">
                             </label>
                             <label class="flex items-center justify-between py-2 border-b border-gray-800 last:border-b-0">
                                 <span class="text-sm text-gray-300">Maintenance Mode (Block Index)</span>
                                 <input type="checkbox" id="toggle-maintenance" class="h-5 w-5 gn-bg border-gray-700 rounded">
                             </label>
                             <label class="flex items-center justify-between py-2 border-b border-gray-800 last:border-b-0">
                                 <span class="text-sm text-gray-300">Disable SEO Indexing</span>
                                 <input type="checkbox" id="toggle-seo" class="h-5 w-5 gn-bg border-gray-700 rounded">
                             </label>
                             <label class="flex items-center justify-between py-2 border-b border-gray-800 last:border-b-0">
                                 <span class="text-sm text-gray-300">Force Image Caching</span>
                                 <input type="checkbox" id="toggle-cache" class="h-5 w-5 gn-bg border-gray-700 rounded">
                             </label>
                        </div>

                        <!-- System Status -->
                         <div class="p-4 border border-gray-700 rounded-lg">
                             <h4 class="text-lg font-bold text-white mb-3">Realtime Database Status</h4>
                             <p class="text-sm text-gray-300 flex justify-between py-1">Connection: <span id="rtdb-status" class="text-yellow-500 font-mono">Loading...</span></p>
                             <p class="text-sm text-gray-300 flex justify-between py-1">Last Updated: <span id="rtdb-last-update" class="text-gray-400 font-mono">N/A</span></p>
                             <button id="reset-peak-btn" class="mt-3 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition"><i class="fa-solid fa-redo"></i> Reset Peak Visitors</button>
                         </div>
                         
                         <!-- Additional Global Stats -->
                         <div class="p-4 border border-gray-700 rounded-lg">
                             <h4 class="text-lg font-bold text-white mb-3">Global Usage Metrics</h4>
                             <p class="text-sm text-gray-300 flex justify-between py-1 border-b border-gray-800">Total Users (Auth): <span id="auth-user-count" class="font-bold">N/A</span></p>
                             <p class="text-sm text-gray-300 flex justify-between py-1 border-b border-gray-800">Total Site Visits: <span id="total-visits-count" class="font-bold">N/A</span></p>
                             <p class="text-sm text-gray-300 flex justify-between py-1 border-b border-gray-800">Apps Needing Update: <span id="apps-needing-update" class="font-bold text-yellow-500">0</span></p>
                         </div>
                    </div>

                    <div id="config-status-msg" class="mt-6 text-sm font-mono text-green-400"></div>
                </div>
            </div>
        </div>

        <!-- THEMED IMPORT MODAL -->
        <div id="import-section" class="hidden mb-10 bg-gray-900 p-8 rounded-2xl border border-gray-700 shadow-2xl relative">
            <!-- ... (Import section content remains the same) ... -->
            <div class="absolute top-0 left-0 w-full h-1 bg-green-500"></div>
            <h3 class="text-2xl font-bold mb-2 text-green-400 flex items-center gap-3"><i class="fa-solid fa-database"></i> Bulk Import</h3>
            <p class="text-gray-500 mb-6 text-sm">Upload <code>apps.json</code> to restore full descriptions.</p>
            
            <div class="flex flex-col gap-6">
                <div class="relative">
                    <input type="file" id="import-file" accept=".json" class="block w-full text-sm text-gray-400 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-green-600 file:text-white hover:file:bg-green-700 cursor-pointer bg-black rounded-lg border border-gray-700">
                </div>
                <textarea id="import-json-data" rows="6" class="w-full bg-black border border-gray-700 rounded-xl p-4 font-mono text-xs text-green-400 focus:outline-none focus:border-green-500 transition" placeholder='[ {"id": "app-id", ...} ]'></textarea>
            </div>
            <div class="flex gap-4 mt-6 pt-6 border-t border-gray-800">
                <button id="run-import-btn" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-play"></i> Run Import
                </button>
                <button id="cancel-import-btn" class="text-gray-500 hover:text-white px-6 py-3 font-bold transition">Cancel</button>
            </div>
            <p id="import-status" class="mt-4 text-sm font-bold font-mono"></p>
        </div>
    </div>
</div>
<footer class="footer">
    <!-- Footer content remains the same -->
</footer>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js"></script>

    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, writeBatch, getDocs, getDoc as getDocFS } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref as dbRef, onValue, update as updateRTDB, runTransaction, get as getRTDB, set as setRTDB } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJrJnSQI7X1YJHLOfHZkknmoAoiOiGuEo",
            authDomain: "getnaroapp.firebaseapp.com",
            databaseURL: "https://getnaroapp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "getnaroapp",
            storageBucket: "getnaroapp.firebasestorage.app",
            messagingSenderId: "304744138530",
            appId: "1:304744138530:web:8166344d61cdfa127ec77b",
            measurementId: "G-FLBX24J98C"
        };

        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        const rtdb = getDatabase(app);

        // --- CUSTOM ALERT SYSTEM ---
        const modal = document.getElementById('custom-modal');
        const userDetailModal = document.getElementById('user-detail-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMsg = document.getElementById('modal-msg');
        const modalInputDiv = document.getElementById('modal-input-container');
        const modalInput = document.getElementById('modal-input');
        const btnConfirm = document.getElementById('modal-confirm');
        const btnCancel = document.getElementById('modal-cancel');

        function showCustomPopup(title, msg, type, callback) {
            modalTitle.textContent = title;
            modalMsg.textContent = msg;
            modal.style.display = 'flex';
            
            modalInputDiv.classList.add('hidden');
            btnCancel.classList.remove('hidden');
            
            if (type === 'alert') {
                btnCancel.classList.add('hidden');
                btnConfirm.textContent = "OK";
                btnConfirm.onclick = () => { modal.style.display = 'none'; if(callback) callback(); };
            } else if (type === 'confirm') {
                btnConfirm.textContent = "Yes";
                btnConfirm.onclick = () => { modal.style.display = 'none'; if(callback) callback(true); };
                btnCancel.onclick = () => { modal.style.display = 'none'; if(callback) callback(false); };
            } else if (type === 'prompt') {
                modalInputDiv.classList.remove('hidden');
                modalInput.value = '';
                modalInput.focus();
                btnConfirm.textContent = "Submit";
                btnConfirm.onclick = () => { modal.style.display = 'none'; if(callback) callback(modalInput.value); };
                btnCancel.onclick = () => { modal.style.display = 'none'; if(callback) callback(null); };
            }
        }

        // Toast Helper
        function showToast(msg, type = 'info') {
            const toast = document.getElementById('admin-toast');
            const span = document.getElementById('toast-msg');
            span.textContent = msg;
            toast.style.borderColor = type === 'error' ? '#ef4444' : (type === 'success' ? '#00e676' : '#9F00FF');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- DOM Elements ---
        const els = {
            loginSection: document.getElementById('login-section'),
            dashboard: document.getElementById('dashboard-content'),
            email: document.getElementById('admin-email'),
            pass: document.getElementById('admin-pass'),
            loginBtn: document.getElementById('admin-login-btn'),
            loginMsg: document.getElementById('login-msg'),
            logoutBtn: document.getElementById('logout-btn'),
            
            // Stats
            stats: {
                apps: document.getElementById('total-apps-count'),
                downloads: document.getElementById('global-downloads-count'),
                ratings: document.getElementById('total-ratings-count'),
                liveVisitors: document.getElementById('live-visitors-count'),
                peakVisitors: document.getElementById('peak-visitors-count'),
                rtdbStatus: document.getElementById('rtdb-status'),
                rtdbLastUpdate: document.getElementById('rtdb-last-update'),
                authUsers: document.getElementById('auth-user-count'),
                totalVisits: document.getElementById('total-visits-count'),
                appsNeedingUpdate: document.getElementById('apps-needing-update')
            },

            // Tabs
            tabButtons: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),

            // App Editor
            saveBtn: document.getElementById('save-app-btn'),
            clearBtn: document.getElementById('clear-form-btn'),
            tableBody: document.getElementById('app-table-body'),
            search: document.getElementById('search-apps'),
            importToggleBtn: document.getElementById('import-toggle-btn'),
            importSection: document.getElementById('import-section'),
            importJsonData: document.getElementById('import-json-data'),
            importFileInput: document.getElementById('import-file'),
            runImportBtn: document.getElementById('run-import-btn'),
            cancelImportBtn: document.getElementById('cancel-import-btn'),
            importStatus: document.getElementById('import-status'),
            deleteAllBtn: document.getElementById('delete-all-btn'),
            inputs: {
                docId: document.getElementById('app-doc-id'),
                id: document.getElementById('app-id'),
                name: document.getElementById('app-name'),
                category: document.getElementById('app-category'),
                version: document.getElementById('app-version'),
                tags: document.getElementById('app-tags'),
                desc: document.getElementById('app-desc'),
                link: document.getElementById('app-download-link'),
                image: document.getElementById('app-image')
            },
            
            // User Manager
            userSearchInput: document.getElementById('user-search-input'),
            searchUserBtn: document.getElementById('search-user-btn'),
            userResultCard: document.getElementById('user-result-card'),
            userDisplayName: document.getElementById('user-display-name'),
            userEmailId: document.getElementById('user-email-id'),
            userDeleteBtn: document.getElementById('user-delete-btn'),
            userDownloadHistory: document.getElementById('user-download-history'),
            userFavourites: document.getElementById('user-favourites'),
            userDataWarning: document.getElementById('user-data-warning'),
            userViewDetailsBtn: document.getElementById('user-view-details-btn'),

            // Config
            resetPeakBtn: document.getElementById('reset-peak-btn'),
            toggleSignups: document.getElementById('toggle-signups'),
            toggleMaintenance: document.getElementById('toggle-maintenance'),
            toggleSeo: document.getElementById('toggle-seo'),
            toggleCache: document.getElementById('toggle-cache'),
            configStatusMsg: document.getElementById('config-status-msg')
        };
        
        let allUsers = []; // Store all users for searching

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Check if user is an admin (assuming a simple check for now)
                // For production, you must check a custom claim or a whitelist of admin UIDs in Firestore.
                // For this exercise, we assume any successful login grants dashboard access.
                els.loginSection.classList.add('hidden');
                els.dashboard.classList.remove('hidden');
                initDashboard();
            } else {
                els.loginSection.classList.remove('hidden');
                els.dashboard.classList.add('hidden');
            }
        });

        els.loginBtn.addEventListener('click', async () => {
            els.loginMsg.textContent = "Authenticating...";
            try {
                await signInWithEmailAndPassword(auth, els.email.value, els.pass.value);
            } catch (e) {
                els.loginMsg.textContent = "Access Denied: " + e.message;
            }
        });

        els.logoutBtn.addEventListener('click', () => signOut(auth));

        // --- NAVIGATION ---
        els.tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.getAttribute('data-tab');
                els.tabButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                els.tabContents.forEach(content => {
                    content.classList.add('hidden');
                    if (content.id === `tab-${targetTab}`) {
                        content.classList.remove('hidden');
                    }
                });
            });
        });

        // --- DATA & RTDB LISTENERS ---
        let allApps = [];

        function initDashboard() {
            // Firestore App List
            loadApps(); 
            
            // Realtime Database Stats (RTDB)
            loadRTDBStats();
            
            // Load Site Config (RTDB)
            loadSiteConfig();
        }
        
        // --- RTDB STATS ---
        function loadRTDBStats() {
            const liveRef = dbRef(rtdb, "stats/live_visitors");
            const peakRef = dbRef(rtdb, "stats/peak_visitors");
            const downloadsRef = dbRef(rtdb, "stats/total_downloads");
            const visitsRef = dbRef(rtdb, "stats/total_visits");
            const connectedRef = dbRef(rtdb, ".info/connected");

            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    els.stats.rtdbStatus.textContent = "Connected";
                    els.stats.rtdbStatus.classList.remove('text-red-500');
                    els.stats.rtdbStatus.classList.add('text-green-500');
                    els.stats.rtdbLastUpdate.textContent = new Date().toLocaleTimeString();
                } else {
                    els.stats.rtdbStatus.textContent = "Disconnected";
                    els.stats.rtdbStatus.classList.remove('text-green-500');
                    els.stats.rtdbStatus.classList.add('text-red-500');
                }
            });

            onValue(liveRef, (snap) => els.stats.liveVisitors.textContent = snap.val() || 0);
            onValue(peakRef, (snap) => els.stats.peakVisitors.textContent = snap.val() || 0);
            onValue(downloadsRef, (snap) => els.stats.downloads.textContent = (snap.val() || 0).toLocaleString());
            onValue(visitsRef, (snap) => els.stats.totalVisits.textContent = (snap.val() || 0).toLocaleString());

            // Reset Peak Button Logic
            els.resetPeakBtn.onclick = () => {
                showCustomPopup("Reset Peak", "Are you sure you want to reset the Peak Visitors counter?", "confirm", (confirmed) => {
                    if (confirmed) {
                        setRTDB(peakRef, els.stats.liveVisitors.textContent.replace(/,/g, ''));
                        showToast("Peak Visitors Reset!", 'success');
                    }
                });
            };
        }
        
        // --- SITE CONFIG MANAGEMENT ---
        function loadSiteConfig() {
            const configRef = dbRef(rtdb, "site_config");
            onValue(configRef, (snap) => {
                const config = snap.val() || {};
                els.toggleSignups.checked = config.disableSignups || false;
                els.toggleMaintenance.checked = config.maintenanceMode || false;
                els.toggleSeo.checked = config.disableSeo || false;
                els.toggleCache.checked = config.forceCache || false;
            });
            
            const handleConfigChange = async () => {
                const payload = {
                    disableSignups: els.toggleSignups.checked,
                    maintenanceMode: els.toggleMaintenance.checked,
                    disableSeo: els.toggleSeo.checked,
                    forceCache: els.toggleCache.checked,
                    lastModified: new Date().toISOString()
                };
                try {
                    await updateRTDB(dbRef(rtdb, "site_config"), payload);
                    els.configStatusMsg.textContent = "Settings saved successfully.";
                    showToast("Config Updated", 'success');
                } catch(e) {
                    els.configStatusMsg.textContent = "Error saving settings: " + e.message;
                    showToast("Config Save Failed", 'error');
                }
            };

            els.toggleSignups.onchange = handleConfigChange;
            els.toggleMaintenance.onchange = handleConfigChange;
            els.toggleSeo.onchange = handleConfigChange;
            els.toggleCache.onchange = handleConfigChange;
        }


        // --- APP MANAGEMENT (Firestore) ---
        function loadApps() {
            const q = query(collection(firestore, "apps"));
            onSnapshot(q, (snapshot) => {
                allApps = [];
                snapshot.forEach(doc => {
                    allApps.push({ _id: doc.id, ...doc.data() });
                });
                
                // Example: Calculate apps needing update (simple heuristic)
                const outdatedApps = allApps.filter(app => {
                    // Check if version is old, or if lastUpdated is over 6 months old
                    const sixMonthsAgo = new Date();
                    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                    const lastUpdatedDate = app.lastUpdated ? new Date(app.lastUpdated) : new Date(0);
                    return lastUpdatedDate < sixMonthsAgo;
                });

                els.stats.appsNeedingUpdate.textContent = outdatedApps.length;
                allApps.sort((a, b) => (b.lastUpdated || "").localeCompare(a.lastUpdated || "")); 
                renderTable(allApps);
                els.stats.apps.textContent = allApps.length;
            });
        }

        function renderTable(apps) {
             els.tableBody.innerHTML = '';
            if (apps.length === 0) {
                els.tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-12 text-center text-gray-500">No apps found. Try Importing JSON.</td></tr>`;
                return;
            }

            apps.forEach(app => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-800/50 transition border-b border-gray-800 last:border-0 group";
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-white group-hover:gn-text transition">${app.name}</div>
                        <div class="text-xs text-gray-600 font-mono">${app._id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="bg-gray-800 text-gray-300 text-xs px-3 py-1 rounded-full border border-gray-700 uppercase font-bold tracking-wide">${app.category}</span>
                    </td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button class="edit-btn bg-gray-800 hover:bg-blue-600 text-gray-400 hover:text-white w-8 h-8 rounded-md transition" data-id="${app._id}"><i class="fa-solid fa-pen"></i></button>
                        <button class="view-btn bg-gray-800 hover:bg-green-600 text-gray-400 hover:text-white w-8 h-8 rounded-md transition" data-id="${app._id}"><i class="fa-solid fa-eye"></i></button>
                        <button class="del-btn bg-gray-800 hover:bg-red-600 text-gray-400 hover:text-white w-8 h-8 rounded-md transition" data-id="${app._id}"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                els.tableBody.appendChild(tr);
            });

            document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => editApp(e.currentTarget.dataset.id)));
            document.querySelectorAll('.del-btn').forEach(b => b.addEventListener('click', (e) => deleteApp(e.currentTarget.dataset.id)));
            document.querySelectorAll('.view-btn').forEach(b => b.addEventListener('click', (e) => window.open(`/pages/view.html?id=${e.currentTarget.dataset.id}`, '_blank')));
        }

        // --- USER MANAGEMENT (RTDB) ---
        // FIX: Combine search into a single event listener that correctly references input
        const executeUserSearch = async () => {
            const query = els.userSearchInput.value.trim();
            if (!query) return showToast("Enter User ID or Email", 'error');

            els.userResultCard.classList.add('hidden');
            els.userDownloadHistory.innerHTML = `<div class="loader mx-auto my-4"></div>`;
            els.userFavourites.innerHTML = `<div class="loader mx-auto my-4"></div>`;
            els.userSearchMsg.textContent = "Searching...";

            try {
                // 1. Search RTDB for profile data
                const userRef = dbRef(rtdb, `users/${query}`);
                let snapshot = await getRTDB(userRef);
                let userData = snapshot.val();
                let uid = query;
                
                // 2. Fallback check for email search (This currently requires getting ALL users, so we fake it for demo)
                if (!userData && query.includes('@')) {
                    els.userSearchMsg.textContent = "Error: Email search requires a cloud function in production.";
                    showToast("Email Search Error", 'error');
                    return;
                }
                
                if (userData) {
                    els.userDisplayName.textContent = userData.name || userData.email.split('@')[0];
                    els.userEmailId.textContent = userData.email;
                    els.userResultCard.classList.remove('hidden');
                    els.userSearchMsg.textContent = `Found user: ${uid}`;
                    els.userDataWarning.classList.remove('hidden');
                    
                    // Populate Details Modal
                    populateUserDetailModal(uid, userData);

                    // Load History and Favorites
                    await loadUserHistory(uid);
                    await loadUserFavorites(uid);
                    
                    // Bind actions
                    els.userDeleteBtn.onclick = () => deleteUserHistory(uid);
                    // Bind the modal view button to show the modal
                    els.userViewDetailsBtn.onclick = () => userDetailModal.style.display = 'flex'; 

                } else {
                    els.userSearchMsg.textContent = `User '${query}' not found in RTDB.`;
                    showToast("User Not Found", 'error');
                }

            } catch (e) {
                console.error(e);
                els.userSearchMsg.textContent = "Error during search.";
                showToast("An error occurred.", 'error');
            }
        };

        // FIX: Attach search handler to button click
        els.searchUserBtn.addEventListener('click', executeUserSearch);
        
        function populateUserDetailModal(uid, userData) {
            document.getElementById('modal-user-uid').textContent = uid;
            document.getElementById('modal-user-name').textContent = userData.name || 'N/A';
            document.getElementById('modal-user-email').textContent = userData.email || 'N/A';
            document.getElementById('modal-user-join-date').textContent = userData.joined ? new Date(userData.joined).toLocaleDateString() : 'N/A';
            document.getElementById('modal-user-status').textContent = 'Active (RTDB)';
            document.getElementById('modal-revoke-btn').onclick = () => showCustomPopup("Auth Revocation", "Revoking session requires Firebase Admin SDK. Please manage via Firebase Console.", "alert");
        }
        
        async function loadUserHistory(uid) {
            const historyRef = dbRef(rtdb, `users/${uid}/history`);
            const snapshot = await getRTDB(historyRef);
            const history = snapshot.val();
            
            if (!history) {
                els.userDownloadHistory.innerHTML = '<p class="text-gray-500 text-xs mt-2">No download history found.</p>';
                return;
            }
            
            let html = '';
            Object.keys(history).forEach(key => {
                const item = history[key];
                const statusColor = item.status === 'Installed' ? 'text-green-400' : (item.status === 'Downloaded' ? 'text-purple-400' : 'text-red-400');
                html += `
                    <div class="data-card">
                        <p class="text-white font-bold">${item.appName || 'Unknown App'}</p>
                        <p class="text-xs text-gray-500">Key: ${key}</p>
                        <p class="text-xs ${statusColor}">${item.status} on ${item.installedDate || 'N/A'}</p>
                        <p class="text-xs text-gray-600 truncate">${item.installLocation || 'No location saved.'}</p>
                        <button data-key="${key}" data-uid="${uid}" data-list="history" class="delete-user-item-btn float-right -mt-8 text-red-500 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                    </div>
                `;
            });
            els.userDownloadHistory.innerHTML = html;
            attachDeleteListeners();
        }

        async function loadUserFavorites(uid) {
            const favRef = dbRef(rtdb, `users/${uid}/favorites`);
            const snapshot = await getRTDB(favRef);
            const favorites = snapshot.val();
            
            if (!favorites) {
                els.userFavourites.innerHTML = '<p class="text-gray-500 text-xs mt-2">No favorites found.</p>';
                return;
            }
            
            let html = '';
            Object.keys(favorites).forEach(key => {
                const item = favorites[key];
                html += `
                    <div class="data-card">
                        <p class="text-white font-bold">${item.appName || 'Unknown App'}</p>
                        <p class="text-xs text-gray-500">Key: ${key}</p>
                        <p class="text-xs text-pink-400">Liked on ${new Date(item.timestamp).toLocaleDateString()}</p>
                        <button data-key="${key}" data-uid="${uid}" data-list="favorites" class="delete-user-item-btn float-right -mt-8 text-red-500 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                    </div>
                `;
            });
            els.userFavourites.innerHTML = html;
            attachDeleteListeners();
        }
        
        function attachDeleteListeners() {
            document.querySelectorAll('.delete-user-item-btn').forEach(btn => {
                btn.onclick = () => {
                    const uid = btn.dataset.uid;
                    const key = btn.dataset.key;
                    const list = btn.dataset.list;
                    
                    showCustomPopup("Delete Item", `Are you sure you want to delete this item from the user's ${list}?`, "confirm", async (confirmed) => {
                        if (confirmed) {
                            try {
                                const itemRef = dbRef(rtdb, `users/${uid}/${list}/${key}`);
                                await setRTDB(itemRef, null);
                                showToast("Item Deleted", 'success');
                                // Refresh the specific list view
                                if (list === 'history') loadUserHistory(uid);
                                else loadUserFavorites(uid);
                            } catch (e) {
                                showToast(`Failed to delete: ${e.message}`, 'error');
                            }
                        }
                    });
                };
            });
        }
        
        async function deleteUserHistory(uid) {
             showCustomPopup("Delete All User Data", "Are you sure you want to permanently delete all history and favorites for this user?", "confirm", async (confirmed) => {
                if (confirmed) {
                    try {
                        await setRTDB(dbRef(rtdb, `users/${uid}/history`), null);
                        await setRTDB(dbRef(rtdb, `users/${uid}/favorites`), null);
                        // In a real app, you'd also delete the Firestore profile doc and Auth entry here.
                        showToast("User Data Wiped!", 'success');
                        els.userResultCard.classList.add('hidden');
                    } catch (e) {
                        showToast(`Failed to wipe user data: ${e.message}`, 'error');
                    }
                }
             });
        }
        
        // --- APP EDITOR BINDINGS (Existing logic) ---
         function editApp(id) {
            const app = allApps.find(a => a._id === id);
            if (!app) return;
            els.inputs.docId.value = app._id; els.inputs.id.value = app.id; els.inputs.name.value = app.name;
            els.inputs.category.value = app.category; els.inputs.version.value = app.version || '';
            els.inputs.tags.value = (app.tags || []).join(', '); els.inputs.desc.value = app.description || '';
            els.inputs.link.value = app.downloadLink || ''; els.inputs.image.value = app.image || '';
            els.inputs.id.disabled = true; 
            els.saveBtn.innerHTML = '<i class="fa-solid fa-pen"></i> Update App';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteApp(id) {
            showCustomPopup("Delete App", `Permanently delete ${id}?`, "confirm", async (confirmed) => {
                if (confirmed) {
                    try {
                        // FIX: Use firestore reference
                        await deleteDoc(doc(firestore, "apps", id));
                        showToast("App Deleted", 'success');
                    } catch(e) { showToast(e.message, 'error'); }
                }
            });
        }

        function clearForm() {
            els.inputs.docId.value=''; els.inputs.id.value=''; els.inputs.id.disabled=false;
            els.inputs.name.value=''; els.inputs.version.value=''; els.inputs.tags.value='';
            els.inputs.desc.value=''; els.inputs.link.value=''; els.inputs.image.value='';
            els.saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> Save App';
        }
        els.clearBtn.addEventListener('click', clearForm);
        
        els.search.addEventListener('input', (e) => {
            const t = e.target.value.toLowerCase();
            renderTable(allApps.filter(a => a.name.toLowerCase().includes(t) || a._id.includes(t)));
        });
        // --- END APP EDITOR BINDINGS ---
        
        // --- IMPORT LOGIC (Original Content) ---
        els.importToggleBtn.addEventListener('click', () => els.importSection.classList.toggle('hidden'));
        els.cancelImportBtn.addEventListener('click', () => { els.importSection.classList.add('hidden'); els.importJsonData.value=''; els.importFileInput.value=''; });

        els.runImportBtn.addEventListener('click', async () => {
            let raw = els.importJsonData.value.trim();
            const file = els.importFileInput.files[0];

            if (!raw && !file) return showToast("Paste JSON or Upload File", 'error');
            
            els.runImportBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            els.runImportBtn.disabled = true;
            els.importStatus.textContent = "Reading data...";
            els.importStatus.className = "mt-4 text-sm font-bold font-mono text-yellow-400";

            try {
                if (file) raw = await file.text();
                const data = JSON.parse(raw);
                if (!Array.isArray(data)) throw new Error("JSON must be an array []");

                els.importStatus.textContent = `Importing ${data.length} items...`;
                
                const batch = writeBatch(firestore);
                data.forEach(item => {
                    if (!item.id || !item.name) return;
                    const ref = doc(firestore, "apps", item.id);
                    batch.set(ref, { ...item, lastUpdated: new Date().toISOString().split('T')[0] }, { merge: true });
                });

                await batch.commit();
                showToast(`Success! Imported ${data.length} apps.`, 'success');
                els.importStatus.textContent = "Done!";
                els.importStatus.className = "mt-4 text-sm font-bold font-mono text-green-400";
                setTimeout(() => {
                    els.importSection.classList.add('hidden');
                    els.importStatus.textContent = "";
                }, 1500);

            } catch (e) {
                showToast("Import Failed", 'error');
                els.importStatus.textContent = "Error: " + e.message;
                els.importStatus.className = "mt-4 text-sm font-bold font-mono text-red-500";
            } finally {
                els.runImportBtn.innerHTML = '<i class="fa-solid fa-play"></i> Run Import';
                els.runImportBtn.disabled = false;
            }
        });
        // --- END IMPORT LOGIC ---
        
        // --- DELETE ALL APPS LOGIC (Wipe Apps) ---
        els.deleteAllBtn.addEventListener('click', () => {
            showCustomPopup("DANGER ZONE", "This will permanently delete ALL apps from Firestore. Continue?", "confirm", (confirmed) => {
                if (confirmed) {
                    showCustomPopup("Verify", "Type DELETE to confirm wipe:", "prompt", async (response) => {
                        if (response === "DELETE") {
                            els.deleteAllBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';
                            els.deleteAllBtn.disabled = true;
                            try {
                                const q = query(collection(firestore, "apps"));
                                const snap = await getDocs(q);
                                const batch = writeBatch(firestore);
                                snap.docs.forEach(doc => batch.delete(doc.ref));
                                await batch.commit();
                                showToast("Firestore App Database Wiped Completely!", 'success');
                            } catch (e) {
                                showToast("Wipe Failed: " + e.message, 'error');
                            } finally {
                                els.deleteAllBtn.innerHTML = '<i class="fa-solid fa-radiation text-red-500"></i> Wipe Apps';
                                els.deleteAllBtn.disabled = false;
                            }
                        } else if (response !== null) {
                            showToast("Wipe Cancelled (Wrong code)", 'error');
                        }
                    });
                }
            });
        });
    </script>
    <script src="/scripts/tod.js"></script>
<script src="/scripts/tog.js"></script>
<script src="/scripts/caro.js"></script>
<script src="/scripts/particles.js"></script>
<script src="/scripts/theme.js"></script>
<script src="/scripts/hamburger.js"></script>
<script src="/scripts/caro.js"></script>
<script type="module" src="/scripts/search.js"></script>
<script type="module" src="/scripts/appstats.js"></script>
<script type="module" src="/scripts/app_tracking.js"></script>
<script type="module" src="/scripts/header_auth.js"></script>
<script type="module" src="/scripts/ai_assistant.js"></script>
<script type="module" src="/scripts/stats.js"></script>
</body>
</html>