<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="stylesheet" href="/stylesheets/header.css">
    <link rel="stylesheet" href="/stylesheets/ai_assistant.css">
    <title>Getnaro Online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script>
        window.addEventListener("pageshow", function (event) {
            var historyTraversal = event.persisted || 
                                   (typeof window.performance != "undefined" && 
                                   window.performance.navigation.type === 2);
            if (historyTraversal) {
                // Page was restored from Back/Forward cache. Force reload.
                window.location.reload();
            }
        });
    </script>

    <meta name="title" content="Getnaro — Free Software, Drivers & Tools Download Hub">
    <meta name="description" content="Getnaro is your all-in-one download hub.">
    <link rel="icon" type="image/x-icon" href="assests/Favicon.png">
</head>

<body>
    <canvas id="gn-particles"></canvas>
    <div class="heading">
        <a href="/index.html"><img src="/assests/logo-getnaro-nobg.png" class="logo"></a>
        <h4>Getnaro</h4>
        <ul>
            <li><a href="/index.html">HOME</a></li>
            <li><a href="/pages/community.html">COMMUNITY</a></li>
            <li><a href="/pages/login.html" style="background-color:#9F00FF; color: white !important; padding: 10px; border-radius: 10px;">ACCOUNT</a></li>
            <li><a href="/pages/about.html">ABOUT US</a></li>
            <li><a href="/pages/faq.html">FAQ</a></li>
        </ul>
        <button id="theme-toggle" class="theme-toggle"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
        <div id="gn-search-btn" class="gn-search-btn"><i class="fa-solid fa-magnifying-glass"></i></div>
        <a class="dl" href="/pages/getnaro-app.html"><i class="fa-solid fa-download"></i> DOWNLOAD APP</a>
    </div>

    <button id="gn-hamburger" class="gn-hamburger" aria-expanded="false"><span class="gn-ham-box"><span class="gn-ham-inner"></span></span></button>
    <nav id="gn-mobile-nav" class="gn-mobile-nav" aria-hidden="true">
        <div class="gn-mobile-backdrop" data-close></div>
        <div class="gn-mobile-panel">
            <ul class="gn-mobile-links">
                <li><a href="/index.html">Home</a></li>
                <li><a href="/pages/login.html">Account</a></li>
            </ul>
        </div>
    </nav>
    <div id="gn-search-overlay" class="gn-search-overlay">
        <div class="gn-search-wrapper">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" id="gn-search-input" placeholder="Search here" autocomplete="off">
            <button id="gn-search-close" class="close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="gn-search-results" class="gn-search-results"></div>
    </div>
    
    <div id="gn-ai-root">
        <div class="gn-ai-fab" id="gn-ai-trigger"><i class="fa-solid fa-robot" style="color: white !important;"></i><span style="color: white !important;">Chat Now</span></div>
        <div class="gn-ai-overlay" id="gn-ai-overlay">
            <div class="gn-ai-box">
                <div class="gn-ai-header">
                    <div class="gn-ai-title">
                        <div class="gn-bot-avatar"><i class="fa-solid fa-brain" style="color: aliceblue !important;"></i></div>
                        <div class="gn-ai-info"><h3>Getnaro Assistant</h3></div>
                    </div>
                    <button class="gn-ai-close" id="gn-ai-close"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="gn-ai-messages" id="gn-ai-chat"><div class="msg bot">Hello!</div></div>
                <div class="gn-ai-input-area">
                    <input type="text" class="gn-ai-input" id="gn-ai-input" placeholder="Type a message..">
                    <button class="gn-ai-btn" id="btn-send"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <style>
            * { font-family: Getnaro; }
            @font-face { font-family: Getnaro; src: url(/assests/Getnaro-medium.ttf); }
            .container { margin-top: 100px; padding: 25px; }
            
            /* The Dashboard Grid */
            .gn-dashboard {
                display: grid;
                grid-template-columns: 300px 1fr 1fr;
                gap: 25px;
                width: 95%; max-width: 1400px; margin: 40px auto; min-height: 600px;
                animation: fadeInUp 0.5s ease;
            }

            .gn-card {
                background: var(--box);
                border: 1px solid rgba(159, 0, 255, 0.2);
                border-radius: 20px; padding: 25px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
                display: flex; flex-direction: column; position: relative; overflow: hidden;
            }

            .profile-col { display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%; }
            .brand-logo-mini { width: 60px; margin-bottom: 20px; align-self: flex-start; filter: drop-shadow(0 0 5px #9F00FF); }
            
            .profile-pic-wrapper { position: relative; width: 130px; height: 130px; margin: 20px auto 30px auto; border-radius: 50%; cursor: pointer; }
            .profile-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #9F00FF; box-shadow: 0 0 20px rgba(159, 0, 255, 0.4); }
            .profile-pic-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; opacity: 0; transition: 0.3s; }
            .profile-pic-wrapper:hover .profile-pic-overlay { opacity: 1; }
            .profile-pic-overlay i { color: white; font-size: 24px; }
            .profile-pic-wrapper.uploading .profile-avatar { opacity: 0.5; }

            .user-details { width: 100%; text-align: left; margin-top: 10px; padding: 0 10px; flex: 1; }
            .user-detail-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(159, 0, 255, 0.1); }
            .user-detail-item label { font-size: 11px; color: #9F00FF; font-weight: bold; display: block; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
            .user-detail-item span { font-size: 15px; color: var(--text); font-weight: 500; display: block; word-break: break-all; }

            .gn-btn-logout { width: 100%; margin-top: 20px; background: transparent; border: 2px solid #ff4444; color: #ff4444; padding: 12px; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; }
            .gn-btn-logout:hover { background: #ff4444; color: white; box-shadow: 0 5px 20px rgba(255, 68, 68, 0.3); }

            .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #9F00FF; }
            .section-header i { font-size: 24px; color: #9F00FF; }
            .section-header h3 { font-size: 20px; margin: 0; color: var(--text); font-weight: bold; }

            .scroll-list { flex: 1; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column; gap: 12px; }
            .scroll-list::-webkit-scrollbar { width: 6px; }
            .scroll-list::-webkit-scrollbar-thumb { background: #9F00FF; border-radius: 10px; }
            
            .list-item { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 15px; transition: 0.2s; cursor: pointer; }
            .light-mode .list-item { background: rgba(0, 0, 0, 0.03); border-color: rgba(0, 0, 0, 0.1); }
            .list-item:hover { background: rgba(159, 0, 255, 0.1); transform: translateX(5px); border-color: #9F00FF; }
            
            .item-icon { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; background: #000; }
            .item-info { flex: 1; }
            .item-info h4 { margin: 0 0 4px 0; font-size: 16px; color: var(--text); }
            .item-info p { margin: 0; font-size: 12px; opacity: 0.7; color: var(--text); }
            .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 20px; background: #9F00FF; color: #fff; }

            .empty-state { text-align: center; margin-top: 50px; opacity: 0.6; }
            .empty-state i { font-size: 40px; margin-bottom: 10px; color: var(--text); }
            .empty-state p { color: var(--text); }

            #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 24px; border-radius: 8px; display: none; z-index: 10000; border: 1px solid #9F00FF; }
            
            @keyframes spin { 100% { transform: rotate(360deg); } }
            @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
            @media (max-width: 992px) { .gn-dashboard { grid-template-columns: 1fr; } .profile-col { flex-direction: row; flex-wrap: wrap; justify-content: space-between; } }
            
            /* 3. LOADING OVERLAY (Shows while we check Auth) */
            #auth-loading {
                text-align: center; width: 100%; margin-top: 100px;
                color: #9F00FF; font-weight: bold; font-size: 18px;
            }
        </style>

        <div id="auth-loading">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Verifying Account...
        </div>

        <div class="gn-dashboard" id="main-dashboard" style="display: none;">
            
            <div class="gn-card profile-col">
                <img src="/assests/logo-getnaro-nobg.png" alt="Logo" class="brand-logo-mini" onerror="this.style.display='none'">
                
                <div class="profile-pic-wrapper" id="pic-wrapper" title="Click to change photo">
                    <img id="u-avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-avatar" alt="Profile">
                    <div class="profile-pic-overlay"><i class="fa-solid fa-camera"></i></div>
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                </div>

                <div class="user-details">
                    <div class="user-detail-item">
                        <label>Name</label> <span id="u-name"></span> </div>
                    <div class="user-detail-item">
                        <label>Username</label> <span id="u-username"></span> </div>
                    <div class="user-detail-item">
                        <label>Email</label> <span id="u-email"></span>
                    </div>
                    <div class="user-detail-item">
                        <label>Phone</label> <span id="u-phone"></span>
                    </div>
                </div>

                <button id="btn-logout" class="gn-btn-logout">
                    <i class="fa-solid fa-power-off"></i> Logout
                </button>
            </div>

            <div class="gn-card">
                <div class="section-header">
                    <i class="fa-solid fa-clock-rotate-left"></i> <h3>Download History</h3>
                </div>
                <div id="history-list" class="scroll-list">
                    <div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i><p>Loading...</p></div>
                </div>
            </div>

            <div class="gn-card">
                <div class="section-header">
                    <i class="fa-solid fa-heart"></i> <h3>My Favourites</h3>
                </div>
                <div id="fav-list" class="scroll-list">
                    <div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i><p>Loading...</p></div>
                </div>
            </div>

        </div>

        <div id="toast">Notification</div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
            import { getAuth, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
            import { getDatabase, ref, onValue, update as updateDB } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
            import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

            const firebaseConfig = {
                apiKey: "AIzaSyAJrJnSQI7X1YJHLOfHZkknmoAoiOiGuEo",
                authDomain: "getnaroapp.firebaseapp.com",
                databaseURL: "https://getnaroapp-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "getnaroapp",
                storageBucket: "getnaroapp.firebasestorage.app",
                messagingSenderId: "304744138530",
                appId: "1:304744138530:web:8166344d61cdfa127ec77b",
                measurementId: "G-FLBX24J98C"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getDatabase(app);
            const storage = getStorage(app);

            const els = {
                loading: document.getElementById('auth-loading'),
                dashboard: document.getElementById('main-dashboard'),
                name: document.getElementById('u-name'),
                user: document.getElementById('u-username'),
                email: document.getElementById('u-email'),
                phone: document.getElementById('u-phone'),
                avatar: document.getElementById('u-avatar'),
                history: document.getElementById('history-list'),
                favs: document.getElementById('fav-list'),
                wrapper: document.getElementById('pic-wrapper'),
                fileInput: document.getElementById('file-input'),
                logoutBtn: document.getElementById('btn-logout')
            };

            const showToast = (msg) => {
                const t = document.getElementById('toast');
                if(t) { t.textContent = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); }
            };

            // Failsafe: If firebase takes too long (5s), redirect.
            setTimeout(() => {
                if(els.dashboard.style.display === 'none') {
                    window.location.href = '/pages/login.html';
                }
            }, 5000);

            // 1. MAIN AUTH LOGIC
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // === LOGGED IN ===
                    // Hide loading, Show dashboard
                    if(els.loading) els.loading.style.display = 'none';
                    if(els.dashboard) els.dashboard.style.display = 'grid';

                    // Populate Data
                    if(els.name) els.name.textContent = user.displayName || "User";
                    if(els.email) els.email.textContent = user.email;
                    
                    if(els.avatar && user.photoURL) {
                        const sep = user.photoURL.includes('?') ? '&' : '?';
                        els.avatar.src = user.photoURL + sep + "v=" + Math.random(); 
                    }

                    // DB Data
                    const userRef = ref(db, 'users/' + user.uid);
                    onValue(userRef, (snapshot) => {
                        const data = snapshot.val() || {};
                        if(els.phone) els.phone.textContent = data.phone || user.phoneNumber || "Not Set";
                        if(els.user) els.user.textContent = data.username ? `@${data.username}` : (user.displayName ? `@${user.displayName.replace(/\s/g,'').toLowerCase()}` : "@user");
                        
                        if(els.avatar && data.photoURL) {
                             const sep = data.photoURL.includes('?') ? '&' : '?';
                             els.avatar.src = data.photoURL + sep + "db=" + Math.random(); 
                        }

                        renderList(data.history || {}, els.history, 'download');
                        renderList(data.favorites || {}, els.favs, 'heart');
                    });

                } else {
                    // === LOGGED OUT ===
                    // Force Redirect immediately
                    console.log("No user found, redirecting to login...");
                    window.location.href = '/pages/login.html';
                    return; // Important: stop execution
                }
            });

            // 2. LOGOUT BUTTON
            if(els.logoutBtn) {
                els.logoutBtn.addEventListener('click', () => {
                    if(confirm("Are you sure you want to logout?")) {
                        // Hide dashboard immediately
                        els.dashboard.style.display = 'none';
                        els.loading.style.display = 'block';
                        els.loading.textContent = "Logging out securely...";

                        signOut(auth).then(() => {
                            window.location.href = '/pages/login.html';
                        }).catch((e) => {
                            console.error(e);
                            showToast("Logout failed. Please try again.");
                            // If error, show again
                            els.dashboard.style.display = 'grid';
                            els.loading.style.display = 'none';
                        });
                    }
                });
            }

            // 3. UPLOAD LOGIC
            if(els.wrapper && els.fileInput) {
                els.wrapper.addEventListener('click', () => els.fileInput.click());
                els.fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    const user = auth.currentUser;
                    if (!file || !user) return;
                    
                    els.wrapper.classList.add('uploading');
                    showToast("Uploading...");
                    try {
                        const picRef = storageRef(storage, 'profile_pics/' + user.uid);
                        await uploadBytes(picRef, file);
                        const url = await getDownloadURL(picRef);
                        await updateProfile(user, { photoURL: url });
                        await updateDB(ref(db, 'users/' + user.uid), { photoURL: url });
                        
                        els.avatar.src = url + "?t=" + new Date().getTime();
                        showToast("Profile picture updated!");
                    } catch (err) {
                        console.error("Upload error:", err);
                        showToast("Error uploading image");
                    } finally {
                        els.wrapper.classList.remove('uploading');
                    }
                });
            }

            function renderList(dataObj, container, type) {
                if(!container) return;
                const items = Object.values(dataObj);
                if (items.length === 0) {
                    container.innerHTML = `<div class="empty-state"><i class="fa-solid ${type === 'download' ? 'fa-ghost' : 'fa-heart-crack'}"></i><p>No items.</p></div>`;
                    return;
                }
                container.innerHTML = '';
                items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                items.forEach(item => {
                    const icon = item.icon || 'https://cdn-icons-png.flaticon.com/512/3616/3616929.png';
                    const name = item.appName || item.name || 'App';
                    const date = item.timestamp ? new Date(item.timestamp).toLocaleDateString() : '';
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `<img src="${icon}" class="item-icon"><div class="item-info"><h4>${name}</h4><p>${date}</p></div><span class="status-badge">${type === 'download' ? 'Installed' : 'Liked'}</span>`;
                    container.appendChild(div);
                });
            }
        </script>
        </div>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-col">
                <h3>Getnaro</h3>
                <p>Official download redirection hub for Windows software.</p>
            </div>
            <div class="footer-col">
                <h3>Quick Links</h3>
                <a href="/pages/t&c.html">Terms & Conditions</a><br>
                <a href="/pages/privacypolicy.html">Privacy Policy</a><br>
                <a href="/pages/contact.html">Contact</a>
            </div>
            <div class="footer-col">
                <h3>Follow Us</h3>
                <div class="footer-social">
                    <a href="https://www.instagram.com/narotech.india"><i class="fa-brands fa-instagram"></i></a>
                    <a href="https://discord.gg/mcxbEsxXcQ"><i class="fa-brands fa-discord"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">© 2025 Getnaro — Developed by NaroTech</div>
    </footer>

    <script src="/scripts/tod.js"></script>
    <script src="/scripts/tog.js"></script>
    <script src="/scripts/caro.js"></script>
    <script src="/scripts/particles.js"></script>
    <script type="module" src="/scripts/download-index.js"></script>
    <script type="module" src="/scripts/ai_assistant.js"></script>
    <script type="module" src="/scripts/stats.js"></script>
    <script src="/scripts/theme.js"></script>
    <script src="/scripts/search.js"></script>
    <script src="/scripts/hamburger.js"></script>
</body>
</html>