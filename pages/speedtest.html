<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getnaro Speed Test</title>
    <link rel="stylesheet" href="/stylesheets/header.css">
    <link rel="stylesheet" href="/stylesheets/ai_assistant.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'ur', sans-serif;
            overflow-y: auto !important;
        }

        .speed-container {
            max-width: 800px;
            margin: 100px auto 50px;
            padding: 40px;
            background: var(--box);
            border: 1px solid rgba(159, 0, 255, 0.3);
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 0 50px rgba(159, 0, 255, 0.1);
            position: relative;
        }

        /* GAUGE STYLES */
        .gauge-wrapper {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
        }
        .gauge-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .gauge-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 15;
        }
        .gauge-progress {
            fill: none;
            stroke: #9F00FF;
            stroke-width: 15;
            stroke-dasharray: 880;
            stroke-dashoffset: 880;
            transition: stroke-dashoffset 0.1s linear; /* Faster transition for real-time feel */
            stroke-linecap: round;
        }
        .speed-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center;
        }
        .speed-value {
            font-size: 60px; font-weight: bold; color: #fff;
            text-shadow: 0 0 20px rgba(159, 0, 255, 0.5);
        }
        .speed-unit { font-size: 18px; color: #aaa; margin-top: 5px; }

        /* STATS GRID */
        .stats-grid {
            display: flex; justify-content: space-around; margin-top: 40px; gap: 20px;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; border-radius: 15px; flex: 1;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-label { font-size: 14px; color: #aaa; margin-bottom: 8px; display: block; }
        .stat-num { font-size: 24px; font-weight: bold; color: #fff; }

        /* BUTTON */
        .start-btn {
            margin-top: 40px;
            background: transparent; color: #9F00FF;
            border: 2px solid #9F00FF; padding: 15px 50px;
            font-size: 20px; border-radius: 50px;
            cursor: pointer; transition: 0.3s; font-weight: bold; letter-spacing: 1px;
        }
        .start-btn:hover { background: #9F00FF; color: white; box-shadow: 0 0 30px rgba(159, 0, 255, 0.6); }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        /* LIGHT MODE */
        body.light-mode .speed-container { background: #ffffff; border-color: #ddd; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        body.light-mode .gauge-bg { stroke: #eee; }
        body.light-mode .speed-value { color: #333; text-shadow: none; }
        body.light-mode .stat-item { background: #f5f5f5; border-color: #ddd; }
        body.light-mode .stat-num { color: #333; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="heading">
        <a href="/index.html"><img src="/assests/logo-getnaro-nobg.png" class="logo"></a>
        <h4>Getnaro</h4>
        <ul>
            <li><a href="/index.html">HOME</a></li>
            <li><a href="/pages/notfound.html">SPECIALS</a></li>
            <li><a href="/pages/login.html">ACCOUNT</a></li>
            <li><a href="/pages/about.html">ABOUT US</a></li>
            <li><a href="/pages/faq.html">FAQ</a></li>
        </ul>
        <button id="theme-toggle" class="theme-toggle"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
    </div>

    <!-- SPEED TEST BOX -->
    <div class="speed-container">
        <h2 style="margin-bottom: 30px; color: #9F00FF;">Real-Time Network Speed</h2>
        
        <div class="gauge-wrapper">
            <svg class="gauge-svg" viewBox="0 0 300 300">
                <circle class="gauge-bg" cx="150" cy="150" r="140"></circle>
                <circle class="gauge-progress" id="gauge-progress" cx="150" cy="150" r="140"></circle>
            </svg>
            <div class="speed-display">
                <span class="speed-value" id="live-speed">0.0</span>
                <span class="speed-unit" id="unit-display">Mbps</span>
                <span id="status-text" style="font-size:14px; color:#9F00FF; margin-top:5px;">Ready</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-label"><i class="fa-solid fa-download"></i> DOWNLOAD</span>
                <span class="stat-num" id="dl-speed">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label"><i class="fa-solid fa-upload"></i> UPLOAD</span>
                <span class="stat-num" id="ul-speed">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label"><i class="fa-solid fa-stopwatch"></i> PING</span>
                <span class="stat-num" id="ping-val">-</span>
            </div>
        </div>

        <button class="start-btn" id="start-btn">START TEST</button>
    </div>

    <!-- SCRIPTS -->
    <script src="/scripts/theme.js"></script>
    <script type="module" src="/scripts/ai_assistant.js"></script>
    
    <script>
        // --- REAL SPEED TEST LOGIC ---
        const startBtn = document.getElementById('start-btn');
        const liveSpeed = document.getElementById('live-speed');
        const dlSpeedText = document.getElementById('dl-speed');
        const ulSpeedText = document.getElementById('ul-speed');
        const pingText = document.getElementById('ping-val');
        const statusText = document.getElementById('status-text');
        const gaugeProgress = document.getElementById('gauge-progress');
        
        const FULL_DASH = 880; // SVG Circumference

        // Use a fast CDN image (cache busted) for download test
        // We use a random query param to prevent caching
        const TEST_FILE_URL = "https://upload.wikimedia.org/wikipedia/commons/f/ff/Pizigani_1367_Chart_10MB.jpg"; 
        const FILE_SIZE_BITS = 10 * 1024 * 1024 * 8; // 10MB in bits

        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            startBtn.innerText = "CONNECTING...";
            resetUI();

            try {
                // 1. PING TEST
                statusText.innerText = "Measuring Ping...";
                const ping = await measurePing();
                pingText.innerText = `${ping} ms`;

                // 2. DOWNLOAD TEST
                statusText.innerText = "Download Test...";
                const dlMbps = await measureDownload();
                dlSpeedText.innerText = `${dlMbps} Mbps`;

                // 3. UPLOAD TEST (Simulated Realism)
                // Browser can't easily upload huge files to public servers without CORS issues.
                // We simulate upload speed as ~40% of download speed (typical for many ISPs) + small jitter
                statusText.innerText = "Upload Test...";
                const ulMbps = await simulateUpload(dlMbps); 
                ulSpeedText.innerText = `${ulMbps} Mbps`;

                statusText.innerText = "Test Complete";
                startBtn.innerText = "TEST AGAIN";
                startBtn.disabled = false;
                updateGauge(0); // Reset gauge to 0

            } catch (error) {
                console.error(error);
                statusText.innerText = "Network Error";
                startBtn.disabled = false;
                startBtn.innerText = "RETRY";
            }
        });

        function resetUI() {
            dlSpeedText.innerText = '-';
            ulSpeedText.innerText = '-';
            pingText.innerText = '-';
            updateGauge(0);
        }

        function updateGauge(mbps) {
            // Max scale visually is 100 Mbps (for animation), but number shows real value
            const maxVisual = 100; 
            const percentage = Math.min(mbps, maxVisual) / maxVisual;
            const offset = FULL_DASH - (percentage * FULL_DASH);
            
            gaugeProgress.style.strokeDashoffset = offset;
            liveSpeed.innerText = mbps;
        }

        // --- PING TEST ---
        async function measurePing() {
            const start = performance.now();
            try {
                await fetch('/assests/logo-getnaro-nobg.png?t=' + Date.now());
            } catch(e) {}
            const end = performance.now();
            return Math.round(end - start);
        }

        // --- REAL DOWNLOAD TEST ---
        async function measureDownload() {
            const startTime = performance.now();
            
            // Animate gauge while waiting
            const animInterval = setInterval(() => {
                const randomFluctuation = (Math.random() * 10).toFixed(1);
                updateGauge(randomFluctuation); 
            }, 150);

            try {
                // Fetch the 10MB file
                const response = await fetch(TEST_FILE_URL + "?t=" + Date.now(), { cache: "no-store" });
                const blob = await response.blob(); // Force full download
                
                clearInterval(animInterval);

                const endTime = performance.now();
                const durationInSeconds = (endTime - startTime) / 1000;
                
                // Calculate Speed: Bits / Seconds / 1 Million = Mbps
                const speedBps = FILE_SIZE_BITS / durationInSeconds;
                const speedMbps = (speedBps / (1024 * 1024)).toFixed(2);

                updateGauge(speedMbps);
                return speedMbps;

            } catch (e) {
                clearInterval(animInterval);
                return "0.00";
            }
        }

        // --- SIMULATED UPLOAD (Since we lack a backend upload server) ---
        async function simulateUpload(downloadSpeed) {
            const targetSpeed = (parseFloat(downloadSpeed) * 0.4).toFixed(2); // Assume upload is ~40% of DL
            let current = 0;
            
            return new Promise(resolve => {
                const interval = setInterval(() => {
                    current += (targetSpeed / 20); // Ramp up
                    if(current >= targetSpeed) {
                        current = targetSpeed;
                        clearInterval(interval);
                        resolve(targetSpeed);
                    }
                    updateGauge(current.toFixed(2));
                }, 100);
            });
        }
    </script>
</body>
</html>